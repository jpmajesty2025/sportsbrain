# Railway Deployment Guide

This guide covers deploying SportsBrain to Railway.app with proper secret management.

## Phase 1: Railway Deployment

### Prerequisites
1. Railway account: https://railway.app
2. Railway CLI: `npm install -g @railway/cli`
3. GitHub repository with your code

### Step 1: Create Railway Project

```bash
# Login to Railway
railway login

# Create new project
railway new

# Link to existing GitHub repo (recommended)
# Or init in current directory
railway init
```

### Step 2: Set Up Database Services

Railway provides managed databases. Add these services to your project:

1. **PostgreSQL Database**
   - Add PostgreSQL service in Railway dashboard
   - Railway will provide `DATABASE_URL` automatically

2. **Redis**
   - Add Redis service in Railway dashboard  
   - Railway will provide `REDIS_URL` automatically

### Step 3: Environment Variables Setup

Set these in Railway Dashboard > Variables:

#### Required Secrets
```env
# Authentication
SECRET_KEY=your-super-secure-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# External APIs
OPENAI_API_KEY=sk-your-openai-api-key
LANGCHAIN_API_KEY=your-langchain-api-key

# Neo4j (if using external service)
NEO4J_URI=bolt://your-neo4j-instance:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your-neo4j-password

# Milvus (if using external service)
MILVUS_HOST=your-milvus-host
MILVUS_PORT=19530

# Application Config
PROJECT_NAME=SportsBrain
API_V1_STR=/api/v1
ENVIRONMENT=production
DEBUG=false

# Frontend
REACT_APP_API_URL=https://your-backend-service.railway.app
```

#### Auto-Generated by Railway
```env
# These are automatically provided by Railway services
DATABASE_URL=postgresql://...
REDIS_URL=redis://...
PORT=8000  # Railway sets this automatically
```

### Step 4: Deploy Backend

1. **Create Backend Service**
   ```bash
   # In your project root
   railway service create backend
   
   # Set service variables
   railway variables set SECRET_KEY="your-secret-key"
   railway variables set OPENAI_API_KEY="sk-your-key"
   # ... set all other variables
   ```

2. **Deploy from GitHub**
   - Connect your GitHub repo in Railway dashboard
   - Set build path to `backend/`
   - Railway will automatically detect Dockerfile

3. **Manual Deploy** (alternative)
   ```bash
   # From backend directory
   cd backend
   railway deploy
   ```

### Step 5: Deploy Frontend

1. **Create Frontend Service**
   ```bash
   railway service create frontend
   
   # Set frontend environment variables
   railway variables set REACT_APP_API_URL="https://your-backend.railway.app"
   ```

2. **Deploy Frontend**
   - Set build path to `frontend/` in Railway dashboard
   - Railway will build and serve the React app

### Step 6: Database Initialization

After backend deployment, initialize the database:

```bash
# Connect to your Railway backend service
railway shell

# Run database migrations
alembic upgrade head

# Or manually run initialization SQL
psql $DATABASE_URL < sql/init.sql
```

### Step 7: Verify Deployment

1. **Check Services**
   ```bash
   railway status
   railway logs
   ```

2. **Test Endpoints**
   - Backend health: `https://your-backend.railway.app/health`
   - API docs: `https://your-backend.railway.app/docs`
   - Frontend: `https://your-frontend.railway.app`

## Security Best Practices

### 1. **Secret Rotation**
```bash
# Update secrets in Railway
railway variables set SECRET_KEY="new-secret-key"
railway redeploy
```

### 2. **Environment Separation**
- Use separate Railway projects for staging/production
- Different API keys and database instances per environment

### 3. **Access Control**
- Use Railway team features for collaborative access
- Set up proper CORS origins in production

## Monitoring & Maintenance

### 1. **Logs**
```bash
# View live logs
railway logs --follow

# Service-specific logs
railway logs backend
railway logs frontend
```

### 2. **Database Backups**
- Railway PostgreSQL includes automatic backups
- Set up additional backup strategies for critical data

### 3. **Scaling**
```bash
# Scale services as needed
railway up --replicas 3
```

## Migration to AWS (Phase 2)

When ready to migrate to AWS:

1. **Export Environment Variables**
   ```bash
   railway variables > production-vars.env
   ```

2. **Use AWS Secrets Manager**
   - Import secrets to AWS Secrets Manager
   - Update application to use AWS SDK for secret retrieval

3. **Infrastructure as Code**
   - Use the included GitHub Actions for AWS deployment
   - Consider AWS CDK or Terraform for infrastructure

## Troubleshooting

### Common Issues

1. **Database Connection Errors**
   ```bash
   # Check DATABASE_URL format
   railway variables get DATABASE_URL
   ```

2. **CORS Issues**
   - Verify REACT_APP_API_URL matches backend URL
   - Check CORS configuration in FastAPI

3. **Build Failures**
   ```bash
   # Check build logs
   railway logs --build
   ```

### Getting Help

- Railway Documentation: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- Check Railway status: https://status.railway.app